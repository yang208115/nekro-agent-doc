# éåŒæœŸã‚¿ã‚¹ã‚¯

> âš ï¸ ã“ã®æ©Ÿèƒ½ã¯ **nekro-agent v2.2.0+** ä»¥é™ã§ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚

## æ¦‚è¦

éåŒæœŸã‚¿ã‚¹ã‚¯ãƒ„ãƒ¼ãƒ«ã«ã‚ˆã‚Šã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ãƒ¡ã‚¤ãƒ³ AI ã®ä¼šè©±èƒ½åŠ›ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã“ã¨ãªãã€é•·æ™‚é–“å®Ÿè¡Œã•ã‚Œã‚‹ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

- **Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™º**: AI ãŒãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Œå…¨ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯ä¼šè©±ã‚’ç¶™ç¶š
- **å‹•ç”»/ç”»åƒç”Ÿæˆ**: æ™‚é–“ã®ã‹ã‹ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”ŸæˆãŒä¼šè©±ã‚’ä¸­æ–­ã—ãªã„
- **ãƒ‡ãƒ¼ã‚¿å‡¦ç†**: å¤§è¦æ¨¡ãªãƒ‡ãƒ¼ã‚¿å‡¦ç†ãŒãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ
- **å¤–éƒ¨ API å‘¼ã³å‡ºã—**: é•·æ™‚é–“ã® API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å¾…æ©Ÿ

### ã‚³ã‚¢æ©Ÿèƒ½

- âœ… **ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°**: ãƒ¡ã‚¤ãƒ³ AI ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ä¼šè©±ã‚’ç¶™ç¶šå¯èƒ½
- âœ… **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¿½è·¡**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®é€²æ—å ±å‘Š
- âœ… **ä¸­æ–­å¯èƒ½**: å®Ÿè¡Œä¸­ã®ã‚¿ã‚¹ã‚¯ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’ã‚µãƒãƒ¼ãƒˆ
- âœ… **åŒæ–¹å‘é€šä¿¡**: ã‚¿ã‚¹ã‚¯ã‹ã‚‰ãƒ¡ã‚¤ãƒ³ Agent ã¸ã®é€šçŸ¥ãŒå¯èƒ½
- âœ… **çµ‚äº†ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯**: ã‚¿ã‚¹ã‚¯å®Œäº†/å¤±æ•—/ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œ

---

## ã‚³ã‚¢ API

### 1. éåŒæœŸã‚¿ã‚¹ã‚¯ã®å®šç¾©

`mount_async_task` ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦éåŒæœŸã‚¿ã‚¹ã‚¯é–¢æ•°ã‚’ç™»éŒ²ã—ã¾ã™ï¼š

```python
from nekro_agent.services.plugin.task import AsyncTaskHandle, TaskCtl, task
from nekro_agent.api.plugin import NekroPlugin
from typing import AsyncGenerator

plugin = NekroPlugin(
    name="éåŒæœŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³",
    module_name="my_async_plugin",
    description="éåŒæœŸã‚¿ã‚¹ã‚¯ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³",
    version="1.0.0",
    author="é–‹ç™ºè€…",
    url="https://github.com/xxx",
)

@plugin.mount_async_task("my_task")
async def my_async_task(
    handle: AsyncTaskHandle,
    prompt: str,
    task_id: str,
) -> AsyncGenerator[TaskCtl, None]:
    """éåŒæœŸã‚¿ã‚¹ã‚¯ã®ã‚µãƒ³ãƒ—ãƒ«"""
    # é€²æ—ã‚’å ±å‘Š
    yield TaskCtl.report_progress("ğŸ” è¦ä»¶ã‚’åˆ†æä¸­...", 10)

    # ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
    if handle.is_cancelled:
        yield TaskCtl.cancel("ã‚¿ã‚¹ã‚¯ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ")
        return

    # ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œ
    yield TaskCtl.report_progress("âš™ï¸ å‡¦ç†ä¸­...", 50)

    # ã‚¿ã‚¹ã‚¯å®Œäº†
    yield TaskCtl.success("å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ", data={"result": "success"})
```

### 2. ã‚¿ã‚¹ã‚¯åˆ¶å¾¡ã‚·ã‚°ãƒŠãƒ« (TaskCtl)

ã‚¿ã‚¹ã‚¯ã¯ `yield TaskCtl.xxx()` ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å ±å‘Šã—ã¾ã™ï¼š

| ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ | çµ‚ç«¯çŠ¶æ…‹ |
|----------|------|----------|
| `TaskCtl.report_progress(msg, percent)` | é€²æ—ã‚’å ±å‘Š | âŒ |
| `TaskCtl.success(msg, data)` | æˆåŠŸå®Œäº† | âœ… |
| `TaskCtl.fail(msg, error)` | ã‚¿ã‚¹ã‚¯å¤±æ•— | âœ… |
| `TaskCtl.cancel(msg)` | ã‚¿ã‚¹ã‚¯ã‚­ãƒ£ãƒ³ã‚»ãƒ« | âœ… |

**TaskCtl ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**:

```python
ctl = TaskCtl.success("å®Œäº†", data={"url": "..."})

ctl.signal      # TaskSignal.SUCCESS
ctl.message     # "å®Œäº†"
ctl.data        # {"url": "..."}
ctl.progress    # None (report_progress æ™‚ã®ã¿å€¤ã‚ã‚Š)
ctl.is_terminal # True (çµ‚ç«¯çŠ¶æ…‹ã‹ã©ã†ã‹)
```

### 3. ã‚¿ã‚¹ã‚¯ãƒãƒ³ãƒ‰ãƒ« (AsyncTaskHandle)

ã‚¿ã‚¹ã‚¯é–¢æ•°ã¯ã‚¿ã‚¹ã‚¯åˆ¶å¾¡ç”¨ã® `AsyncTaskHandle` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šã¾ã™ï¼š

| ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£/ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
|---------------------|------|
| `handle.task_id` | ã‚¿ã‚¹ã‚¯ ID |
| `handle.chat_key` | ãƒãƒ£ãƒƒãƒˆ Key |
| `handle.plugin` | ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ |
| `handle.is_cancelled` | ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯ |
| `await handle.wait(key, timeout)` | å¤–éƒ¨ã‚·ã‚°ãƒŠãƒ«ã‚’å¾…æ©Ÿ |
| `handle.notify(key, data)` | å¾…æ©Ÿãƒã‚¤ãƒ³ãƒˆã‚’å†é–‹ |
| `await handle.notify_agent(message, trigger)` | ãƒ¡ã‚¤ãƒ³ Agent ã«é€šçŸ¥ |
| `handle.cancel_wait(key)` | ç‰¹å®šã®å¾…æ©Ÿãƒã‚¤ãƒ³ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ« |
| `handle.cancel_all()` | ã™ã¹ã¦ã®å¾…æ©Ÿãƒã‚¤ãƒ³ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ« |

### 4. ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¿ã‚¹ã‚¯ API (task)

ã‚°ãƒ­ãƒ¼ãƒãƒ« `task` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚¿ã‚¹ã‚¯ã‚’åˆ¶å¾¡ï¼š

| ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
|----------|------|
| `await task.start(type, id, chat_key, plugin, ..., on_terminal=callback)` | ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ |
| `task.is_running(type, id)` | å®Ÿè¡Œä¸­ã‹ãƒã‚§ãƒƒã‚¯ |
| `await task.cancel(type, id)` | ã‚¿ã‚¹ã‚¯ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ« |
| `await task.stop_all()` | ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã‚’åœæ­¢ |
| `task.get_handle(type, id)` | ã‚¿ã‚¹ã‚¯ãƒãƒ³ãƒ‰ãƒ«ã‚’å–å¾— |
| `task.get_state(type, id)` | æœ€æ–°ã®ã‚¿ã‚¹ã‚¯çŠ¶æ…‹ã‚’å–å¾— |
| `task.get_running_tasks()` | å®Ÿè¡Œä¸­ã®ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’å–å¾— |

---

## çµ‚ç«¯ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ (on_terminal)

**v2.2.0 æ–°æ©Ÿèƒ½**: ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®Ÿè¡Œã—ã€ãƒªã‚½ãƒ¼ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚„é€šçŸ¥ãªã©ã«ä½¿ç”¨ã§ãã¾ã™ã€‚

### åŸºæœ¬çš„ãªä½¿ã„æ–¹

```python
from nekro_agent.services.plugin.task import TaskCtl, task

def handle_task_complete(ctl: TaskCtl) -> None:
    """ã‚¿ã‚¹ã‚¯å®Œäº†ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯"""
    if ctl.signal == TaskSignal.SUCCESS:
        print(f"âœ… ã‚¿ã‚¹ã‚¯æˆåŠŸ: {ctl.message}")
        print(f"   çµæœãƒ‡ãƒ¼ã‚¿: {ctl.data}")
    elif ctl.signal == TaskSignal.FAIL:
        print(f"âŒ ã‚¿ã‚¹ã‚¯å¤±æ•—: {ctl.message}")
    elif ctl.signal == TaskSignal.CANCEL:
        print(f"âš ï¸ ã‚¿ã‚¹ã‚¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«: {ctl.message}")

# ã‚¿ã‚¹ã‚¯é–‹å§‹æ™‚ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’æ¸¡ã™
await task.start(
    task_type="my_task",
    task_id="T001",
    chat_key=_ctx.chat_key,
    plugin=plugin,
    prompt="ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ",
    on_terminal=handle_task_complete,  # çµ‚ç«¯ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
)
```

### ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶

ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯ä»¥ä¸‹ã®çŠ¶æ³ã§ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã™ï¼š

| ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ | TaskCtl ã‚·ã‚°ãƒŠãƒ« |
|--------------|------------------|
| ã‚¿ã‚¹ã‚¯ãŒ `TaskCtl.success()` ã‚’ yield | `TaskSignal.SUCCESS` |
| ã‚¿ã‚¹ã‚¯ãŒ `TaskCtl.fail()` ã‚’ yield | `TaskSignal.FAIL` |
| ã‚¿ã‚¹ã‚¯ãŒ `TaskCtl.cancel()` ã‚’ yield | `TaskSignal.CANCEL` |
| å¤–éƒ¨ã‹ã‚‰ `task.cancel()` ã‚’å‘¼ã³å‡ºã— | `TaskSignal.CANCEL` |
| ã‚¿ã‚¹ã‚¯ãŒä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ | `TaskSignal.FAIL` |

### å®Ÿè·µçš„ãªä¾‹

```python
@plugin.mount_sandbox_method(SandboxMethodType.TOOL, "é–‹ç™ºã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ")
async def create_dev_task(_ctx: AgentCtx, requirement: str) -> str:
    """é–‹ç™ºã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ"""
    task_id = f"DEV_{int(time.time())}"
    
    def _on_terminal(ctl: TaskCtl) -> None:
        """ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ã«è‡ªå‹•é€šçŸ¥"""
        import asyncio
        from nekro_agent.services.message_service import message_service
        
        if ctl.signal == TaskSignal.SUCCESS:
            url = ctl.data.get("url", "")
            msg = f"âœ… é–‹ç™ºã‚¿ã‚¹ã‚¯å®Œäº†!\nğŸ”— {url}"
        else:
            msg = f"âŒ é–‹ç™ºã‚¿ã‚¹ã‚¯å¤±æ•—: {ctl.message}"
        
        # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…ã§éåŒæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
        asyncio.create_task(
            message_service.push_system_message(
                chat_key=_ctx.chat_key,
                agent_messages=msg,
                trigger_agent=True,
            )
        )
    
    await task.start(
        task_type="webapp_dev",
        task_id=task_id,
        chat_key=_ctx.chat_key,
        plugin=plugin,
        requirement=requirement,
        task_id=task_id,
        on_terminal=_on_terminal,
    )
    
    return f"ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã—ã¾ã—ãŸ: {task_id}"
```

---

## å®Œå…¨ãªä¾‹: WebApp é–‹ç™ºã‚¿ã‚¹ã‚¯

### éåŒæœŸã‚¿ã‚¹ã‚¯ã®å®šç¾©

```python
@plugin.mount_async_task("webapp_dev")
async def webapp_development_task(
    handle: AsyncTaskHandle,
    requirement: str,
    task_id: str,
) -> AsyncGenerator[TaskCtl, None]:
    """WebApp é–‹ç™ºéåŒæœŸã‚¿ã‚¹ã‚¯"""
    yield TaskCtl.report_progress("ğŸš€ é–‹ç™ºã‚’é–‹å§‹...", 0)

    # é–‹ç™ºã‚’å®Ÿè¡Œ
    success, result = await run_developer_loop(requirement)

    if success:
        yield TaskCtl.report_progress("ğŸ“¦ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ä¸­...", 70)
        yield TaskCtl.success("ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ", data={"url": url})
    else:
        yield TaskCtl.fail(f"é–‹ç™ºå¤±æ•—: {result}")
```

### ã‚¿ã‚¹ã‚¯ã®é–‹å§‹

```python
from nekro_agent.api.schemas import AgentCtx

@plugin.mount_sandbox_method(SandboxMethodType.TOOL, "WebApp ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ")
async def create_webapp_task(
    _ctx: AgentCtx,
    requirement: str,
) -> str:
    """WebApp é–‹ç™ºã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ"""
    task_id = generate_task_id()

    # éåŒæœŸã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ï¼ˆãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰
    await task.start(
        task_type="webapp_dev",
        task_id=task_id,
        chat_key=_ctx.chat_key,
        plugin=plugin,
        requirement=requirement,
        task_id=task_id,
    )

    return f"ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã—ã¾ã—ãŸ: {task_id}"
```

---

## ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. ã‚¿ã‚¹ã‚¯è¨­è¨ˆ

```python
# âœ… æ¨å¥¨: æ˜ç¢ºãªã‚¿ã‚¹ã‚¯ãƒ•ã‚§ãƒ¼ã‚º
yield TaskCtl.report_progress("ğŸ“¥ ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...", 20)
yield TaskCtl.report_progress("ğŸ”„ å‡¦ç†ä¸­...", 60)
yield TaskCtl.report_progress("ğŸ’¾ ä¿å­˜ä¸­...", 90)

# âŒ éæ¨å¥¨: æ›–æ˜§ãªé€²æ—
yield TaskCtl.report_progress("å‡¦ç†ä¸­...", 50)
yield TaskCtl.report_progress("ã‚‚ã†ã™ãå®Œäº†...", 80)
```

### 2. ã‚¨ãƒ©ãƒ¼å‡¦ç†

```python
try:
    result = await external_api()
    yield TaskCtl.success("å®Œäº†", data=result)
except TimeoutError:
    yield TaskCtl.fail("API ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ")
except Exception as e:
    yield TaskCtl.fail(f"ã‚¨ãƒ©ãƒ¼: {e}")
```

### 3. ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

```python
@plugin.on_disabled()
async def cleanup():
    count = await task.stop_all()
    if count > 0:
        logger.info(f"{count} å€‹ã®ã‚¿ã‚¹ã‚¯ã‚’åœæ­¢ã—ã¾ã—ãŸ")
```

### 4. åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡

```python
MAX_CONCURRENT_TASKS = 3

@plugin.mount_sandbox_method(SandboxMethodType.TOOL, "start_task")
async def start_task(_ctx: AgentCtx, name: str) -> str:
    active = len([t for t in task.get_running_tasks() if "my_plugin" in t])
    if active >= MAX_CONCURRENT_TASKS:
        raise ValueError(f"æœ€å¤§åŒæ™‚å®Ÿè¡Œæ•°ã«é”ã—ã¾ã—ãŸ ({MAX_CONCURRENT_TASKS})")

    await task.start("my_task", task_id, _ctx.chat_key, plugin, name)
    return f"ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã—ã¾ã—ãŸ: {task_id}"
```

### 5. çµ‚ç«¯ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®æ³¨æ„ç‚¹

```python
# âœ… æ¨å¥¨: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…ã§éåŒæœŸæ“ä½œã‚’å‡¦ç†
def _on_terminal(ctl: TaskCtl) -> None:
    import asyncio
    asyncio.create_task(send_notification(ctl))

# âŒ éæ¨å¥¨: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…ã§ç›´æ¥ awaitï¼ˆã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯åŒæœŸé–¢æ•°ï¼‰
def _on_terminal(ctl: TaskCtl) -> None:
    await send_notification(ctl)  # ã‚¨ãƒ©ãƒ¼ï¼
```

---

## ã‚ˆãã‚ã‚‹è³ªå•

### Q: éåŒæœŸã‚¿ã‚¹ã‚¯ã¨é€šå¸¸ã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã®é•ã„ã¯ï¼Ÿ

| æ¯”è¼ƒé …ç›® | ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ | éåŒæœŸã‚¿ã‚¹ã‚¯ |
|----------|------------------------|--------------|
| å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚° | å‘¼ã³å‡ºã—æ™‚ã«å³åº§ã«å®Ÿè¡Œ | å‘¼ã³å‡ºã—å¾Œãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ |
| ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒƒãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯ | ã™ã‚‹ | ã—ãªã„ |
| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¿½è·¡ | ãªã— | å®Œå…¨ãªé€²æ—å ±å‘Š |
| é•·æ™‚é–“å®Ÿè¡Œ | ä¸å‘ã | é©ã—ã¦ã„ã‚‹ |
| ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯èƒ½ | ä¸å¯ | å¯èƒ½ |
| çµ‚ç«¯ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ | éå¯¾å¿œ | å¯¾å¿œ |

### Q: ã‚¿ã‚¹ã‚¯ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªã‚’å¾…ãŸã›ã‚‹ã«ã¯ï¼Ÿ

```python
@plugin.mount_async_task("approval_task")
async def task_with_approval(handle: AsyncTaskHandle, prompt: str):
    yield TaskCtl.report_progress("â³ æ‰¿èªã‚’å¾…æ©Ÿä¸­...", 50)

    # å¤–éƒ¨ã‹ã‚‰ã® notify() å‘¼ã³å‡ºã—ã‚’å¾…æ©Ÿ
    approved = await handle.wait("approval", timeout=3600)

    if approved:
        yield TaskCtl.success("æ‰¿èªã•ã‚Œã¾ã—ãŸ")
    else:
        yield TaskCtl.fail("æ‰¿èªã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ãŸã¯æ‹’å¦ã•ã‚Œã¾ã—ãŸ")
```

### Q: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã¯éåŒæœŸã«ã§ãã¾ã™ã‹ï¼Ÿ

ã„ã„ãˆã€‚`on_terminal` ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯åŒæœŸé–¢æ•°ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚éåŒæœŸæ“ä½œãŒå¿…è¦ãªå ´åˆã¯ã€`asyncio.create_task()` ã§ãƒ©ãƒƒãƒ—ã—ã¦ãã ã•ã„ï¼š

```python
def _on_terminal(ctl: TaskCtl) -> None:
    asyncio.create_task(async_cleanup(ctl))
```

---

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±

- **æ©Ÿèƒ½ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: nekro-agent v2.2.0+
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.1.0
- **æœ€çµ‚æ›´æ–°**: 2026-01-31
