# å¼‚æ­¥ä»»åŠ¡å·¥å…·

> âš ï¸ æ­¤åŠŸèƒ½ä»…åœ¨ **nekro-agent v2.2.0+** æˆ–å½“å‰é¢„è§ˆç‰ˆæœ¬ä¸­å¯ç”¨ã€‚

## æ¦‚è¿°

å¼‚æ­¥ä»»åŠ¡å·¥å…·å…è®¸æ’ä»¶æ‰§è¡Œé•¿æ—¶é—´è¿è¡Œçš„åå°ä»»åŠ¡ï¼Œè€Œä¸ä¼šé˜»å¡ä¸» AI çš„å¯¹è¯èƒ½åŠ›ã€‚

### ä½¿ç”¨åœºæ™¯

- **Web åº”ç”¨å¼€å‘**: AI åœ¨åå°ç”Ÿæˆå®Œæ•´åº”ç”¨ï¼Œå‰ç«¯ç»§ç»­å¯¹è¯
- **è§†é¢‘/å›¾ç‰‡ç”Ÿæˆ**: è€—æ—¶å†…å®¹ç”Ÿæˆä¸ä¸­æ–­å¯¹è¯
- **æ•°æ®å¤„ç†**: å¤§è§„æ¨¡æ•°æ®å¤„ç†åœ¨åå°è¿è¡Œ
- **å¤–éƒ¨ API è°ƒç”¨**: ç­‰å¾…é•¿æ—¶é—´ API å“åº”

### æ ¸å¿ƒç‰¹æ€§

- âœ… **éé˜»å¡**: ä¸» AI å¯ç»§ç»­ä¸ç”¨æˆ·å¯¹è¯
- âœ… **çŠ¶æ€è¿½è¸ª**: å®æ—¶æŠ¥å‘Šä»»åŠ¡è¿›åº¦
- âœ… **å¯ä¸­æ–­**: æ”¯æŒå–æ¶ˆæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡
- âœ… **åŒå‘é€šä¿¡**: ä»»åŠ¡å¯é€šçŸ¥ä¸» Agent

---

## æ ¸å¿ƒ API

### 1. å®šä¹‰å¼‚æ­¥ä»»åŠ¡

ä½¿ç”¨ `mount_async_task` è£…é¥°å™¨æ³¨å†Œå¼‚æ­¥ä»»åŠ¡å‡½æ•°ï¼š

```python
from nekro_agent.services.plugin.task import AsyncTaskHandle, TaskCtl, task
from nekro_agent.api.plugin import NekroPlugin
from typing import AsyncGenerator

plugin = NekroPlugin(
    name="æˆ‘çš„å¼‚æ­¥æ’ä»¶",
    module_name="my_async_plugin",
    description="å¼‚æ­¥ä»»åŠ¡ç¤ºä¾‹æ’ä»¶",
    version="1.0.0",
    author="å¼€å‘è€…",
    url="https://github.com/xxx",
)

@plugin.mount_async_task("my_task")
async def my_async_task(
    handle: AsyncTaskHandle,
    prompt: str,
    task_id: str,
) -> AsyncGenerator[TaskCtl, None]:
    """å¼‚æ­¥ä»»åŠ¡ç¤ºä¾‹"""
    # æŠ¥å‘Šè¿›åº¦
    yield TaskCtl.report_progress("ğŸ” åˆ†æéœ€æ±‚...", 10)

    # æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ
    if handle.is_cancelled:
        yield TaskCtl.cancel("ä»»åŠ¡å·²å–æ¶ˆ")
        return

    # æ‰§è¡Œä»»åŠ¡æ­¥éª¤
    yield TaskCtl.report_progress("âš™ï¸ å¤„ç†ä¸­...", 50)

    # ä»»åŠ¡å®Œæˆ
    yield TaskCtl.success("å¤„ç†å®Œæˆ", data={"result": "success"})
```

### 2. ä»»åŠ¡æ§åˆ¶ä¿¡å· (TaskCtl)

ä»»åŠ¡é€šè¿‡ `yield TaskCtl.xxx()` æŠ¥å‘ŠçŠ¶æ€ï¼š

| æ–¹æ³• | è¯´æ˜ | ç»ˆæ€ |
|------|------|------|
| `TaskCtl.report_progress(msg, percent)` | æŠ¥å‘Šè¿›åº¦ | âŒ |
| `TaskCtl.success(msg, data)` | æˆåŠŸå®Œæˆ | âœ… |
| `TaskCtl.fail(msg, error)` | ä»»åŠ¡å¤±è´¥ | âœ… |
| `TaskCtl.cancel(msg)` | ä»»åŠ¡å–æ¶ˆ | âœ… |

### 3. ä»»åŠ¡å¥æŸ„ (AsyncTaskHandle)

ä»»åŠ¡å‡½æ•°æ¥æ”¶ `AsyncTaskHandle` å‚æ•°ï¼š

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `handle.wait(key, timeout)` | ç­‰å¾…å¤–éƒ¨ä¿¡å· |
| `handle.notify(key, data)` | é€šçŸ¥ç­‰å¾…ç‚¹æ¢å¤ |
| `handle.notify_agent(message)` | é€šçŸ¥ä¸» Agent |
| `handle.is_cancelled` | æ£€æŸ¥æ˜¯å¦å·²å–æ¶ˆ |

### 4. å…¨å±€ä»»åŠ¡ API (task)

é€šè¿‡ `task` å…¨å±€å¯¹è±¡æ§åˆ¶ä»»åŠ¡ï¼š

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `await task.start(type, id, chat_key, plugin, ...)` | å¯åŠ¨ä»»åŠ¡ |
| `task.is_running(type, id)` | æ£€æŸ¥æ˜¯å¦è¿è¡Œ |
| `await task.cancel(type, id)` | å–æ¶ˆä»»åŠ¡ |
| `await task.stop_all()` | åœæ­¢æ‰€æœ‰ä»»åŠ¡ |
| `task.get_handle(type, id)` | è·å–ä»»åŠ¡å¥æŸ„ |

---

## å®Œæ•´ç¤ºä¾‹ï¼šWebApp å¼€å‘ä»»åŠ¡

### å®šä¹‰å¼‚æ­¥ä»»åŠ¡

```python
@plugin.mount_async_task("webapp_dev")
async def webapp_development_task(
    handle: AsyncTaskHandle,
    requirement: str,
    task_id: str,
) -> AsyncGenerator[TaskCtl, None]:
    """WebApp å¼€å‘å¼‚æ­¥ä»»åŠ¡"""
    yield TaskCtl.report_progress("ğŸš€ å¼€å§‹å¼€å‘...", 0)

    # æ‰§è¡Œå¼€å‘
    success, result = await run_developer_loop(requirement)

    if success:
        yield TaskCtl.report_progress("ğŸ“¦ ç¼–è¯‘ä¸­...", 70)
        yield TaskCtl.success("éƒ¨ç½²æˆåŠŸ", data={"url": url})
    else:
        yield TaskCtl.fail(f"å¼€å‘å¤±è´¥: {result}")
```

### å¯åŠ¨ä»»åŠ¡

```python
from nekro_agent.api.schemas import AgentCtx

@plugin.mount_sandbox_method(SandboxMethodType.TOOL, "åˆ›å»ºWebAppä»»åŠ¡")
async def create_webapp_task(
    _ctx: AgentCtx,
    requirement: str,
) -> str:
    """åˆ›å»º WebApp å¼€å‘ä»»åŠ¡"""
    task_id = generate_task_id()

    # å¯åŠ¨å¼‚æ­¥ä»»åŠ¡ï¼ˆä¸é˜»å¡ï¼‰
    await task.start(
        task_type="webapp_dev",
        task_id=task_id,
        chat_key=_ctx.chat_key,
        plugin=plugin,
        requirement=requirement,
        task_id=task_id,
    )

    return f"ä»»åŠ¡å·²å¯åŠ¨: {task_id}"
```

### ä¸ä¸» Agent äº¤äº’

```python
# ä»»åŠ¡å®Œæˆåé€šçŸ¥ä¸» Agent
await handle.notify_agent(
    f"âœ… WebApp éƒ¨ç½²æˆåŠŸ!\nğŸ”— {url}"
)

# å®æ—¶åé¦ˆï¼ˆæ‰“æ–­å½“å‰æ“ä½œï¼‰
state_obj = runtime_state.get_state(chat_key, task_id)
if state_obj and state_obj.inject_feedback(new_requirement):
    return "âš¡ å·²æ³¨å…¥åé¦ˆ"
```

---

## æœ€ä½³å®è·µ

### 1. ä»»åŠ¡è®¾è®¡

```python
# âœ… æ¨èï¼šæ¸…æ™°çš„ä»»åŠ¡é˜¶æ®µ
yield TaskCtl.report_progress("ğŸ“¥ ä¸‹è½½èµ„æº...", 20)
yield TaskCtl.report_progress("ğŸ”„ å¤„ç†ä¸­...", 60)
yield TaskCtl.report_progress("ğŸ’¾ ä¿å­˜ä¸­...", 90)

# âŒ ä¸æ¨èï¼šæ¨¡ç³Šçš„è¿›åº¦
yield TaskCtl.report_progress("å¤„ç†ä¸­...", 50)
yield TaskCtl.report_progress("å¿«å®Œæˆäº†...", 80)
```

### 2. é”™è¯¯å¤„ç†

```python
try:
    result = await external_api()
    yield TaskCtl.success("å®Œæˆ", data=result)
except TimeoutError:
    yield TaskCtl.fail("API è¶…æ—¶")
except Exception as e:
    yield TaskCtl.fail(f"é”™è¯¯: {e}")
```

### 3. èµ„æºæ¸…ç†

```python
@plugin.on_disabled()
async def cleanup():
    count = await task.stop_all()
    if count > 0:
        logger.info(f"å·²åœæ­¢ {count} ä¸ªä»»åŠ¡")
```

### 4. å¹¶å‘æ§åˆ¶

```python
MAX_CONCURRENT_TASKS = 3

@plugin.mount_sandbox_method(SandboxMethodType.TOOL, "start_task")
async def start_task(_ctx: AgentCtx, name: str) -> str:
    active = len([t for t in task.get_running_tasks() if "my_plugin" in t])
    if active >= MAX_CONCURRENT_TASKS:
        raise ValueError(f"å·²è¾¾æœ€å¤§å¹¶å‘æ•° ({MAX_CONCURRENT_TASKS})")

    await task.start("my_task", task_id, _ctx.chat_key, plugin, name)
    return f"ä»»åŠ¡å·²å¯åŠ¨: {task_id}"
```

---

## å¸¸è§é—®é¢˜

### Q: å¼‚æ­¥ä»»åŠ¡å’Œæ™®é€šæ²™ç›’æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

| å¯¹æ¯”é¡¹ | æ²™ç›’æ–¹æ³• | å¼‚æ­¥ä»»åŠ¡ |
|--------|----------|----------|
| æ‰§è¡Œæ—¶æœº | è°ƒç”¨æ—¶ç«‹å³æ‰§è¡Œ | è°ƒç”¨ååå°è¿è¡Œ |
| é˜»å¡ä¸»å¯¹è¯ | é˜»å¡ | ä¸é˜»å¡ |
| çŠ¶æ€è¿½è¸ª | æ—  | å®Œæ•´è¿›åº¦æŠ¥å‘Š |
| é•¿æ—¶é—´è¿è¡Œ | ä¸é€‚åˆ | é€‚åˆ |
| å¯å–æ¶ˆ | ä¸å¯ | å¯å–æ¶ˆ |

### Q: å¦‚ä½•è®©ä»»åŠ¡ç­‰å¾…ç”¨æˆ·ç¡®è®¤ï¼Ÿ

```python
@plugin.mount_async_task("approval_task")
async def task_with_approval(handle: AsyncTaskHandle, prompt: str):
    yield TaskCtl.report_progress("â³ ç­‰å¾…å®¡æ‰¹...", 50)

    # ç­‰å¾…å¤–éƒ¨è°ƒç”¨ notify()
    approved = await handle.wait("approval", timeout=3600)

    if approved:
        yield TaskCtl.success("å·²æ‰¹å‡†")
    else:
        yield TaskCtl.fail("å®¡æ‰¹è¶…æ—¶æˆ–è¢«æ‹’ç»")
```

### Q: ä»»åŠ¡å®Œæˆåå¦‚ä½•é€šçŸ¥ç”¨æˆ·ï¼Ÿ

```python
await handle.notify_agent(
    f"âœ… ä»»åŠ¡å®Œæˆ!\nç»“æœ: {result}"
)
```

---

## ç‰ˆæœ¬ä¿¡æ¯

- **åŠŸèƒ½ç‰ˆæœ¬**: nekro-agent v2.2.0+
- **æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
- **æœ€åæ›´æ–°**: 2026-01-30
